<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cyber Threat Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #0d1117; color: #c9d1d9; }
        .card { background-color: #161b22; margin-bottom: 1rem; border: 1px solid #30363d; }
        .severity-High { background-color: #da3633; color: white; padding: 2px 6px; border-radius: 4px; }
        .severity-Medium { background-color: #e3b341; color: white; padding: 2px 6px; border-radius: 4px; }
        .severity-Low { background-color: #238636; color: white; padding: 2px 6px; border-radius: 4px; }
        #map { height: 500px; margin-top: 1rem; }
    </style>
</head>
<body>
<div class="container-fluid p-4">
    <h1 class="text-info">Cyber Threat Dashboard</h1>
    <div class="row mb-3">
        <div class="col-md-2"><input id="search" class="form-control" placeholder="Search name..."></div>
        <div class="col-md-2">
            <select id="type" class="form-select">
                <option value="">All Types</option>
                <option value="Exploit">Exploit</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="publisher" class="form-select">
                <option value="">All Publishers</option>
                <option value="AlienVault">AlienVault</option>
            </select>
        </div>
        <div class="col-md-2">
            <select id="severity" class="form-select">
                <option value="">All Severities</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div class="col-md-1"><button class="btn btn-success" onclick="loadThreats()">Apply</button></div>
        <div class="col-md-1"><button class="btn btn-primary" onclick="exportCSV()">Export</button></div>
    </div>
    <div class="row">
        <div class="col-md-4" id="threats"></div>
        <div class="col-md-8"><div id="map"></div></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    let map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    let markers = [];

    function loadThreats() {
        const params = new URLSearchParams({
            type: document.getElementById("type").value,
            publisher: document.getElementById("publisher").value,
            severity: document.getElementById("severity").value,
            search: document.getElementById("search").value
        });
        fetch(`/api/threats?${params}`)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById("threats");
                container.innerHTML = "";
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                data.threats.forEach(threat => {
                    const card = document.createElement("div");
                    card.className = "card p-3";
                    card.innerHTML = `
                        <h5>${threat.title}</h5>
                        <p>${threat.publisher} | ${threat.type} | 
                            <span class="severity-${threat.severity}">${threat.severity}</span></p>
                        <small>${threat.timestamp}</small>
                    `;
                    container.appendChild(card);

                    if (threat.coordinates) {
                        const marker = L.marker(threat.coordinates).addTo(map)
                            .bindPopup(`<b>${threat.title}</b><br>${threat.publisher}`);
                        markers.push(marker);
                    }
                });
            });
    }

    function exportCSV() {
        fetch(`/api/threats`)
            .then(res => res.json())
            .then(data => {
                const headers = ["Title", "Publisher", "Type", "Severity", "Timestamp"];
                const rows = data.threats.map(t => [t.title, t.publisher, t.type, t.severity, t.timestamp]);
                let csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
                const blob = new Blob([csv], { type: 'text/csv' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "threats.csv";
                link.click();
            });
    }

    loadThreats();
</script>
</body>
</html>